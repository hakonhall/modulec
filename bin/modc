#!/bin/bash

function Fail {
    echo "$*" >&2
    exit 1
}

type readlink &> /dev/null || Fail "Missing dependency: readlink"
type java &> /dev/null || Fail "Missing dependency: java"

# To launch the Java JVM with the modulec main class, we need to locate it.
# We'll assume modulec.class is in ../target/classes relative to the directory
# this file is in, so the task is reduced to finding what directory we're in.
#
# 'readlink -m "$0/.."' has been verified to work for these cases:
# 1. PWD is somewhere else, and a relative path is used to refer to this file.
# 2. PWD is somewhere else, and a symlink contains the relative path to this
# file.
# 3. PWD is somewhere else and PATH contains this directory.
#
# Therefore, the class path must be set to...
class_path=$(readlink -m "$0/.."/../target/classes)

main_class=no.ion.modulec.ModuleCompiler2
main_class_path="$class_path"/"${main_class//.//}".class
if ! test -r "$main_class_path"
then
    Fail "error: modulec file does not exist: $main_class_path"
fi

exec java -cp "$class_path" "$main_class" "$@"

# java -p ~/local/github/hakonhall/modulec/target/no.ion.modulec-1.0.0.jar -m no.ion.modulec/no.ion.modulec.ModuleCompiler2 -w out2 -m -s src1 -m -s src2
